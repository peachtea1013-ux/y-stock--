<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0f172a">
  <title>åœ¨åº«ç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
  <style>
    :root {
      --primary: #2563eb;
      --danger: #dc2626;
      --warning: #f59e0b;
      --success: #16a34a;
      --dark: #0f172a;
      --gray: #64748b;
      --bg: #f8fafc;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo", sans-serif;
      background: var(--bg);
      color: #0f172a;
      padding-bottom: 84px;
      font-size: 15px;
    }
    h1, h2, h3, h4 { margin: 0 0 12px 0; }
    .page { display: none; padding: 16px; }
    .page.active { display: block; }
    .card {
      background: #fff;
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.08);
    }
    .badge { display: inline-block; padding: 3px 10px; border-radius: 999px; font-size: 12px; color: #fff; }
    .row { display: flex; gap: 8px; align-items: center; }
    .row-between { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
    .input {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      font-size: 16px;
      background: #fff;
    }
    .input.small { padding: 10px; font-size: 14px; }
    .input.inline { width: auto; }
    .btn {
      border: none;
      border-radius: 10px;
      padding: 12px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
    }
    .btn.primary { background: var(--primary); color: #fff; }
    .btn.success { background: var(--success); color: #fff; }
    .btn.danger { background: var(--danger); color: #fff; }
    .btn.warning { background: var(--warning); color: #fff; }
    .btn.ghost { background: transparent; border: 1px solid #cbd5f5; color: #1e293b; }
    .btn.block { width: 100%; }
    .tag { font-size: 12px; color: var(--gray); }
    .status-text { font-size: 12px; font-weight: 700; }
    .list-item { border-bottom: 1px solid #e2e8f0; padding: 10px 0; }
    .list-item:last-child { border-bottom: none; }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #fff;
      border-top: 1px solid #e2e8f0;
      display: flex;
      z-index: 50;
    }
    .nav-item {
      flex: 1;
      text-align: center;
      padding: 12px 6px;
      font-size: 12px;
      color: #475569;
      border-top: 3px solid transparent;
    }
    .nav-item.active {
      color: var(--primary);
      border-top-color: var(--primary);
      font-weight: 700;
    }

    .alert-shortage { background: #fff1f2; border: 1px solid #fecdd3; }
    .alert-order { background: #fff7ed; border: 1px solid #fed7aa; }

    .category-chip { font-size: 12px; font-weight: 700; padding: 3px 10px; border-radius: 999px; color: #fff; }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 200;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: #fff;
      width: 100%;
      max-width: 560px;
      border-radius: 16px;
      padding: 16px;
      max-height: 85vh;
      overflow-y: auto;
    }
    body.modal-open { overflow: hidden; }
    body.modal-open .bottom-nav { display: none; }

    .section-title { font-size: 16px; font-weight: 700; margin-bottom: 8px; }
    .muted { color: #64748b; font-size: 12px; }

    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      text-align: center;
    }
    .calendar .day {
      padding: 8px 2px;
      border-radius: 8px;
      background: #fff;
      border: 1px solid #e2e8f0;
      font-size: 12px;
      min-height: 54px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 4px;
    }
    .calendar .day.has-event { border: 2px solid var(--primary); }
    .calendar .day.selected { background: #dbeafe; border-color: var(--primary); }
    .calendar .day-header { font-weight: 700; font-size: 12px; color: #64748b; }

    .inventory-row { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
    .inventory-row input { width: 90px; }

    .history-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .history-table th, .history-table td { border-bottom: 1px solid #e2e8f0; padding: 8px; text-align: left; }
    .history-table th { background: #f1f5f9; position: sticky; top: 0; z-index: 1; }

    .info-box { background: #f1f5f9; border-radius: 12px; padding: 12px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <main>
    <section id="page-stock" class="page active">
      <div class="card" style="background:var(--dark); color:#fff;">
        <div class="tag">åœ¨åº«ç·è³‡ç”£</div>
        <div style="font-size:28px; font-weight:700;">Â¥ <span id="totalAsset">0</span></div>
      </div>

      <div class="card">
        <div class="row" style="gap:12px;">
          <input id="stockSearch" class="input" type="text" placeholder="ğŸ” å•†å“åã§æ¤œç´¢" oninput="renderStockList()">
          <select id="stockCategoryFilter" class="input" onchange="renderStockList()"></select>
        </div>
      </div>

      <div id="shortageNotice"></div>
      <div id="stockList"></div>
    </section>

    <section id="page-history" class="page">
      <div class="card">
        <h3>æ“ä½œå±¥æ­´ï¼ˆæœ€æ–°1000ä»¶ï¼‰</h3>
        <div class="row" style="gap:12px;">
          <input id="historySearch" class="input" type="text" placeholder="å•†å“åã§æ¤œç´¢" oninput="renderHistory()">
          <select id="historyCategoryFilter" class="input" onchange="renderHistory()"></select>
        </div>
      </div>
      <div class="card" style="padding:0;">
        <table class="history-table">
          <thead>
            <tr>
              <th>æ—¥æ™‚</th>
              <th>å•†å“å</th>
              <th>ã‚³ãƒ¼ãƒ‰</th>
              <th>ã‚«ãƒ†ã‚´ãƒª</th>
              <th>ç¨®åˆ¥</th>
              <th>æ•°é‡</th>
              <th>æ“ä½œå¾Œåœ¨åº«</th>
              <th>ä½¿ç”¨ç†ç”±</th>
              <th>çªç™ºç†ç”±</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="historyList"></tbody>
        </table>
      </div>
    </section>

    <section id="page-master" class="page">
      <div class="card">
        <h3>å•†å“ãƒã‚¹ã‚¿ç®¡ç†</h3>
        <button class="btn primary block" onclick="openModal('itemModal')"> æ–°è¦å•†å“ã‚’ç™»éŒ²</button>
      </div>

      <div class="card">
        <h4>CSVé€£æº</h4>
        <div class="row" style="flex-wrap:wrap;">
          <button class="btn success" onclick="exportItemsCSV()">å•†å“ãƒã‚¹ã‚¿CSVå‡ºåŠ›</button>
          <button class="btn success" onclick="exportHistoryCSV()">æ“ä½œå±¥æ­´CSVå‡ºåŠ›</button>
        </div>
        <div style="margin-top:12px;">
          <label class="btn ghost block" for="importCSV">CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆå•†å“ãƒã‚¹ã‚¿ï¼‰</label>
          <input id="importCSV" type="file" accept=".csv" class="hidden" onchange="importItemsCSV(event)">
        </div>
      </div>

      <div class="card">
        <div class="row-between">
          <h4>æ£šå¸</h4>
          <button class="btn primary" onclick="openInventory()">æ£šå¸é–‹å§‹</button>
        </div>
        <div class="muted">é€”ä¸­çµ‚äº†ãƒ»å†é–‹å¯èƒ½ã€‚ç¢ºå®šã™ã‚‹ã¨åœ¨åº«ãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚</div>
      </div>

      <div id="masterList"></div>
    </section>

    <section id="page-calendar" class="page">
      <div class="card">
        <h3>äº¤æ›å‘¨æœŸãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h3>
        <div class="row-between">
          <button class="btn ghost" onclick="changeMonth(-1)">å‰æœˆ</button>
          <div id="calendarTitle" style="font-weight:700;"></div>
          <button class="btn ghost" onclick="changeMonth(1)">æ¬¡æœˆ</button>
        </div>
      </div>
      <div class="card" style="display:grid; grid-template-rows: 2fr 1fr; gap:12px;">
        <div>
          <div class="calendar" id="calendarGrid"></div>
        </div>
        <div>
          <div class="section-title">äº¤æ›äºˆå®šãƒªã‚¹ãƒˆ</div>
          <div id="exchangeList" class="info-box"></div>
        </div>
      </div>
    </section>
  </main>

  <nav class="bottom-nav">
    <div class="nav-item active" onclick="showPage('stock', event)">åœ¨åº«æ“ä½œ</div>
    <div class="nav-item" onclick="showPage('history', event)">å±¥æ­´</div>
    <div class="nav-item" onclick="showPage('master', event)">ãƒã‚¹ã‚¿/æ£šå¸</div>
    <div class="nav-item" onclick="showPage('calendar', event)">äº¤æ›å‘¨æœŸ</div>
  </nav>

  <datalist id="history-name"></datalist>
  <datalist id="history-maker"></datalist>
  <datalist id="history-model"></datalist>
  <datalist id="history-category"></datalist>

  <div id="useModal" class="modal">
    <div class="modal-content">
      <h3>ä½¿ç”¨ç†ç”±</h3>
      <div class="row">
        <select id="useReason" class="input" onchange="toggleSuddenReason()">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="å®šæœŸäº¤æ›">å®šæœŸäº¤æ›</option>
          <option value="çªç™ºäº¤æ›">çªç™ºäº¤æ›</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
      </div>
      <div id="suddenReasonArea" class="hidden" style="margin-top:10px;">
        <div class="section-title">çªç™ºäº¤æ›ç†ç”±</div>
        <div class="row" style="flex-wrap:wrap;">
          <button class="btn ghost" onclick="setSuddenReason('ç ´æ')">ç ´æ</button>
          <button class="btn ghost" onclick="setSuddenReason('ç´›å¤±')">ç´›å¤±</button>
          <button class="btn ghost" onclick="setSuddenReason('æ‘©è€—')">æ‘©è€—</button>
          <button class="btn ghost" onclick="setSuddenReason('åŠ£åŒ–')">åŠ£åŒ–</button>
        </div>
        <input id="suddenReason" class="input" type="text" placeholder="çªç™ºç†ç”±" style="margin-top:8px;" readonly>
      </div>
      <textarea id="useNote" class="input" rows="3" placeholder="å‚™è€ƒ"></textarea>
      <div class="row" style="margin-top:12px;">
        <button class="btn ghost" onclick="closeModal('useModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn danger" onclick="confirmUse()">ä½¿ç”¨ç™»éŒ²</button>
      </div>
    </div>
  </div>

  <div id="orderModal" class="modal">
    <div class="modal-content">
      <h3>ç™ºæ³¨ä¾é ¼</h3>
      <select id="orderStatus" class="input">
        <option value="ä¾é ¼ä¸­">ä¾é ¼ä¸­</option>
        <option value="å®Œäº†">å®Œäº†</option>
      </select>
      <input id="orderQty" class="input" type="number" inputmode="numeric" placeholder="ç™ºæ³¨æ•°é‡">
      <input id="orderDate" class="input" type="date">
      <input id="orderDue" class="input" type="date">
      <textarea id="orderNote" class="input" rows="3" placeholder="å‚™è€ƒ"></textarea>
      <div class="row" style="margin-top:12px;">
        <button class="btn ghost" onclick="closeModal('orderModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn warning" onclick="saveOrderRequest()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div id="itemModal" class="modal">
    <div class="modal-content">
      <h3>å•†å“ãƒã‚¹ã‚¿ç™»éŒ²</h3>
      <input id="itemCode" class="input" type="text" placeholder="å•†å“ã‚³ãƒ¼ãƒ‰ï¼ˆé‡è¤‡ä¸å¯ï¼‰">
      <input id="itemName" class="input" type="text" list="history-name" placeholder="å“å">
      <div class="row">
        <input id="itemMaker" class="input" type="text" list="history-maker" placeholder="ãƒ¡ãƒ¼ã‚«ãƒ¼">
        <input id="itemModel" class="input" type="text" list="history-model" placeholder="å‹å¼ï¼ˆå“ç•ªï¼‰">
      </div>
      <input id="itemCategory" class="input" type="text" list="history-category" placeholder="ã‚«ãƒ†ã‚´ãƒªãƒ¼">
      <div class="row">
        <input id="itemMin" class="input" type="number" inputmode="numeric" placeholder="æœ€ä½åœ¨åº«æ•°">
        <input id="itemStock" class="input" type="number" inputmode="numeric" placeholder="ç¾åœ¨åº«æ•°">
      </div>
      <div class="row">
        <input id="itemPrice" class="input" type="number" inputmode="numeric" placeholder="é‡‘é¡">
        <input id="itemLead" class="input" type="number" inputmode="numeric" placeholder="ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ï¼ˆæ—¥æ•°ï¼‰">
      </div>
      <div class="row">
        <input id="itemCycle" class="input" type="number" inputmode="numeric" placeholder="äº¤æ›å‘¨æœŸï¼ˆæ—¥æ•°ï¼‰">
        <input id="itemNotes" class="input" type="text" placeholder="å‚™è€ƒ">
      </div>
      <div class="row" style="margin-top:12px;">
        <button class="btn ghost" onclick="closeModal('itemModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn primary" onclick="saveItem()">ç™»éŒ²</button>
      </div>
    </div>
  </div>

  <div id="inventoryModal" class="modal">
    <div class="modal-content">
      <div class="row-between">
        <h3>æ£šå¸</h3>
        <button class="btn ghost" onclick="closeModal('inventoryModal')">é–‰ã˜ã‚‹</button>
      </div>
      <div class="row" style="gap:8px; margin-bottom:12px;">
        <label class="muted">ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸¦ã³æ›¿ãˆ</label>
        <select id="inventorySort" class="input small" onchange="renderInventoryList()">
          <option value="name">å“åé †</option>
          <option value="category">ã‚«ãƒ†ã‚´ãƒªãƒ¼é †</option>
        </select>
      </div>
      <div id="inventoryList"></div>
      <button class="btn success block" onclick="confirmInventory()">æ£šå¸ç¢ºå®š</button>
    </div>
  </div>

  <div id="historyEditModal" class="modal">
    <div class="modal-content">
      <h3>å±¥æ­´ç·¨é›†</h3>
      <select id="editType" class="input">
        <option value="ä½¿ç”¨">ä½¿ç”¨</option>
        <option value="ç´å…¥">ç´å…¥</option>
        <option value="æ£šå¸">æ£šå¸</option>
        <option value="ä¿®æ­£">ä¿®æ­£</option>
      </select>
      <input id="editQty" class="input" type="number" inputmode="numeric" placeholder="æ•°é‡">
      <input id="editAfter" class="input" type="number" inputmode="numeric" placeholder="æ“ä½œå¾Œåœ¨åº«æ•°">
      <input id="editReason" class="input" type="text" placeholder="ä½¿ç”¨ç†ç”±">
      <input id="editSudden" class="input" type="text" placeholder="çªç™ºäº¤æ›ç†ç”±">
      <textarea id="editNote" class="input" rows="3" placeholder="å‚™è€ƒ"></textarea>
      <div class="row" style="margin-top:12px;">
        <button class="btn ghost" onclick="closeModal('historyEditModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn primary" onclick="saveHistoryEdit()">æ›´æ–°</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEYS = {
      items: 'inventory_items_v1',
      logs: 'inventory_logs_v1',
      history: 'inventory_input_history_v1',
      inventoryDraft: 'inventory_draft_v1',
      categoryColors: 'inventory_category_colors_v1'
    };

    const state = {
      items: [],
      logs: [],
      history: { names: [], makers: [], models: [], categories: [] },
      categoryColors: {},
      selectedItemId: null,
      selectedLogId: null,
      inventoryDraft: {},
      calendarMonth: new Date()
    };

    const COLOR_PALETTE = [
      '#3b82f6', '#0ea5e9', '#22c55e', '#10b981', '#f97316',
      '#f43f5e', '#a855f7', '#14b8a6', '#84cc16', '#eab308'
    ];

    const loadState = () => {
      state.items = JSON.parse(localStorage.getItem(STORAGE_KEYS.items)) || [];
      state.logs = JSON.parse(localStorage.getItem(STORAGE_KEYS.logs)) || [];
      state.history = JSON.parse(localStorage.getItem(STORAGE_KEYS.history)) || state.history;
      state.categoryColors = JSON.parse(localStorage.getItem(STORAGE_KEYS.categoryColors)) || {};
      state.inventoryDraft = JSON.parse(localStorage.getItem(STORAGE_KEYS.inventoryDraft)) || {};
    };

    const saveState = () => {
      localStorage.setItem(STORAGE_KEYS.items, JSON.stringify(state.items));
      localStorage.setItem(STORAGE_KEYS.logs, JSON.stringify(state.logs.slice(0, 1000)));
      localStorage.setItem(STORAGE_KEYS.history, JSON.stringify(state.history));
      localStorage.setItem(STORAGE_KEYS.categoryColors, JSON.stringify(state.categoryColors));
      localStorage.setItem(STORAGE_KEYS.inventoryDraft, JSON.stringify(state.inventoryDraft));
    };

    const showPage = (pageId, event) => {
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      document.getElementById(`page-${pageId}`).classList.add('active');
      if (event) event.currentTarget.classList.add('active');
      if (pageId === 'calendar') renderCalendar();
    };

    const openModal = (id) => {
      document.getElementById(id).classList.add('active');
      document.body.classList.add('modal-open');
    };

    const closeModal = (id) => {
      document.getElementById(id).classList.remove('active');
      document.body.classList.remove('modal-open');
      if (id === 'useModal') resetUseModal();
      if (id === 'orderModal') resetOrderModal();
      if (id === 'itemModal') {
        clearItemModal();
        document.querySelector('#itemModal .btn.primary').onclick = saveItem;
      }
    };

    const resetUseModal = () => {
      document.getElementById('useReason').value = '';
      document.getElementById('suddenReason').value = '';
      document.getElementById('useNote').value = '';
      document.getElementById('suddenReasonArea').classList.add('hidden');
    };

    const resetOrderModal = () => {
      document.getElementById('orderStatus').value = 'ä¾é ¼ä¸­';
      document.getElementById('orderQty').value = '';
      document.getElementById('orderDate').value = '';
      document.getElementById('orderDue').value = '';
      document.getElementById('orderNote').value = '';
    };

    const toggleSuddenReason = () => {
      const reason = document.getElementById('useReason').value;
      const area = document.getElementById('suddenReasonArea');
      if (reason === 'çªç™ºäº¤æ›') {
        area.classList.remove('hidden');
      } else {
        area.classList.add('hidden');
        document.getElementById('suddenReason').value = '';
      }
    };

    const setSuddenReason = (reason) => {
      document.getElementById('suddenReason').value = reason;
    };

    const addToHistory = (key, value) => {
      if (!value) return;
      const arr = state.history[key];
      if (!arr.includes(value)) arr.push(value);
    };

    const updateHistoryDatalist = () => {
      const setOptions = (id, list) => {
        document.getElementById(id).innerHTML = list.map(value => `<option value="${value}"></option>`).join('');
      };
      setOptions('history-name', state.history.names);
      setOptions('history-maker', state.history.makers);
      setOptions('history-model', state.history.models);
      setOptions('history-category', state.history.categories);
    };

    const assignCategoryColor = (category) => {
      if (!category) return '#94a3b8';
      if (state.categoryColors[category]) return state.categoryColors[category];
      const color = COLOR_PALETTE[Object.keys(state.categoryColors).length % COLOR_PALETTE.length];
      state.categoryColors[category] = color;
      return color;
    };

    const getCategoryList = () => {
      const categories = state.items.filter(item => !item.deleted).map(item => item.category).filter(Boolean);
      return [...new Set(categories)];
    };

    const renderCategoryFilters = () => {
      const categories = getCategoryList();
      const stockFilter = document.getElementById('stockCategoryFilter');
      const historyFilter = document.getElementById('historyCategoryFilter');
      const options = ['<option value="">å…¨ã‚«ãƒ†ã‚´ãƒª</option>'].concat(
        categories.map(cat => `<option value="${cat}">${cat}</option>`)
      );
      stockFilter.innerHTML = options.join('');
      historyFilter.innerHTML = options.join('');
    };

    const calculateTotalAsset = () => {
      const total = state.items.filter(item => !item.deleted)
        .reduce((sum, item) => sum  (item.stock * (item.price || 0)), 0);
      document.getElementById('totalAsset').textContent = total.toLocaleString();
    };

    const getAlertClass = (item) => {
      if (item.stock <= item.minStock) return 'alert-shortage';
      if (item.orderRequest && item.orderRequest.status === 'ä¾é ¼ä¸­') return 'alert-order';
      return '';
    };

    const renderShortageNotice = () => {
      const shortage = state.items.filter(item => !item.deleted && item.stock <= item.minStock);
      const container = document.getElementById('shortageNotice');
      if (shortage.length === 0) {
        container.innerHTML = '';
        return;
      }
      container.innerHTML = `
        <div class="card alert-shortage">
          <div style="font-weight:700; color:var(--danger); margin-bottom:6px;">è³¼å…¥ä¾é ¼ã—ã¦ãã ã•ã„</div>
          <div>${shortage.map(item => item.name).join(' / ')}</div>
        </div>
      `;
    };

    const renderStockList = () => {
      const search = document.getElementById('stockSearch').value.trim().toLowerCase();
      const category = document.getElementById('stockCategoryFilter').value;
      const list = state.items.filter(item => !item.deleted).filter(item => {
        const matchesSearch = item.name.toLowerCase().includes(search);
        const matchesCategory = !category || item.category === category;
        return matchesSearch && matchesCategory;
      });

      const container = document.getElementById('stockList');
      container.innerHTML = list.map(item => {
        const categoryColor = assignCategoryColor(item.category);
        const alertClass = getAlertClass(item);
        const orderInfo = item.orderRequest && item.orderRequest.status === 'ä¾é ¼ä¸­'
          ? `<div class="muted">ç™ºæ³¨: ${item.orderRequest.qty || '-'} / ${item.orderRequest.orderDate || '-'} / ${item.orderRequest.expectedDate || '-'}</div>`
          : '';
        const shortageText = item.stock <= item.minStock ? '<div class="status-text" style="color:var(--danger);">è³¼å…¥ä¾é ¼ã—ã¦ãã ã•ã„</div>' : '';
        const orderStatus = item.orderRequest
          ? `<div class="status-text" style="color:${item.orderRequest.status === 'ä¾é ¼ä¸­' ? 'var(--warning)' : 'var(--success)'};">ç™ºæ³¨${item.orderRequest.status}</div>`
          : '';
        return `
          <div class="card ${alertClass}">
            <div class="row-between">
              <div>
                <span class="category-chip" style="background:${categoryColor};">${item.category || 'æœªåˆ†é¡'}</span>
                <div class="muted">${item.maker} / ${item.model}</div>
                <div style="font-size:18px; font-weight:700;">${item.name}</div>
                ${orderStatus}
                ${orderInfo}
                ${shortageText}
              </div>
              <div style="text-align:right;">
                <div style="font-size:26px; font-weight:700;">${item.stock}</div>
                <div class="muted">Â¥${(item.stock * (item.price || 0)).toLocaleString()}</div>
              </div>
            </div>
            <div class="row" style="margin-top:12px;">
              <input id="qty-${item.id}" type="number" inputmode="numeric" class="input small" placeholder="æ•°é‡">
              <button class="btn danger" onclick="openUseModal(${item.id})">ä½¿ç”¨</button>
              <button class="btn success" onclick="receiveItem(${item.id})">ç´å…¥</button>
              <button class="btn warning" onclick="openOrderModal(${item.id})">ç™ºæ³¨</button>
            </div>
          </div>
        `;
      }).join('');
    };

    const renderMasterList = () => {
      const container = document.getElementById('masterList');
      const list = state.items.filter(item => !item.deleted);
      container.innerHTML = list.map(item => {
        return `
          <div class="card">
            <div class="row-between">
              <div>
                <div style="font-weight:700;">${item.name}</div>
                <div class="muted">ã‚³ãƒ¼ãƒ‰: ${item.code} / ${item.category}</div>
                <div class="muted">æœ€ä½åœ¨åº«: ${item.minStock} / ç¾åœ¨åº«: ${item.stock}</div>
                <div class="muted">äº¤æ›å‘¨æœŸ: ${item.cycleDays || '-'}æ—¥ / æœ€çµ‚æ£šå¸: ${item.lastInventoryDate || '-'}</div>
              </div>
              <div class="row" style="flex-direction:column;">
                <button class="btn ghost" onclick="editItem('${item.id}')">ç·¨é›†</button>
                <button class="btn ghost" onclick="deleteItem('${item.id}')" style="color:var(--danger);">å‰Šé™¤</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    };

    const renderHistory = () => {
      const search = document.getElementById('historySearch').value.trim().toLowerCase();
      const category = document.getElementById('historyCategoryFilter').value;
      const list = state.logs
        .filter(log => !category || log.category === category)
        .filter(log => (log.itemName || '').toLowerCase().includes(search))
        .slice(0, 1000);

      const tbody = document.getElementById('historyList');
      tbody.innerHTML = list.map(log => `
        <tr>
          <td>${log.date}</td>
          <td>${log.itemName}</td>
          <td>${log.itemCode}</td>
          <td>${log.category}</td>
          <td>${log.type}</td>
          <td>${log.qty}</td>
          <td>${log.afterStock}</td>
          <td>${log.useReason || '-'}</td>
          <td>${log.suddenReason || '-'}</td>
          <td><button class="btn ghost" onclick="openHistoryEdit('${log.id}')">ç·¨é›†</button></td>
        </tr>
      `).join('');
    };

    const openUseModal = (itemId) => {
      const qty = document.getElementById(`qty-${itemId}`).value;
      if (!qty || Number(qty) <= 0) {
        alert('æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      state.selectedItemId = itemId;
      openModal('useModal');
    };

    const confirmUse = () => {
      const reason = document.getElementById('useReason').value;
      if (!reason) {
        alert('ä½¿ç”¨ç†ç”±ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      const suddenReason = document.getElementById('suddenReason').value;
      if (reason === 'çªç™ºäº¤æ›' && !suddenReason) {
        alert('çªç™ºäº¤æ›ç†ç”±ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      const note = document.getElementById('useNote').value;
      const qty = Number(document.getElementById(`qty-${state.selectedItemId}`).value);
      updateStock(state.selectedItemId, -qty, 'ä½¿ç”¨', reason, suddenReason, note);
      document.getElementById(`qty-${state.selectedItemId}`).value = '';
      closeModal('useModal');
    };

    const receiveItem = (itemId) => {
      const qty = Number(document.getElementById(`qty-${itemId}`).value);
      if (!qty || qty <= 0) {
        alert('æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      updateStock(itemId, qty, 'ç´å…¥', '', '', '');
      document.getElementById(`qty-${itemId}`).value = '';
    };

    const openOrderModal = (itemId) => {
      state.selectedItemId = itemId;
      const item = state.items.find(i => i.id === itemId);
      if (item && item.orderRequest) {
        document.getElementById('orderStatus').value = item.orderRequest.status;
        document.getElementById('orderQty').value = item.orderRequest.qty || '';
        document.getElementById('orderDate').value = item.orderRequest.orderDate || '';
        document.getElementById('orderDue').value = item.orderRequest.expectedDate || '';
        document.getElementById('orderNote').value = item.orderRequest.note || '';
      }
      openModal('orderModal');
    };

    const saveOrderRequest = () => {
      const item = state.items.find(i => i.id === state.selectedItemId);
      if (!item) return;
      item.orderRequest = {
        status: document.getElementById('orderStatus').value,
        qty: Number(document.getElementById('orderQty').value) || 0,
        orderDate: document.getElementById('orderDate').value,
        expectedDate: document.getElementById('orderDue').value,
        note: document.getElementById('orderNote').value
      };
      saveAll();
      closeModal('orderModal');
    };

    const updateStock = (itemId, delta, type, useReason, suddenReason, note) => {
      const item = state.items.find(i => i.id === itemId);
      if (!item) return;
      item.stock = Math.max(0, item.stock  delta);
      const now = new Date();
      const log = {
        id: `log-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`,
        timestamp: now.getTime(),
        date: now.toLocaleString('ja-JP'),
        itemCode: item.code,
        itemName: item.name,
        category: item.category,
        type,
        qty: Math.abs(delta),
        afterStock: item.stock,
        useReason,
        suddenReason,
        note,
        editedAt: ''
      };
      state.logs.unshift(log);
      if (type === 'ä½¿ç”¨') item.lastUseDate = now.toISOString().slice(0, 10);
      saveAll();
    };

    const saveItem = () => {
      const code = document.getElementById('itemCode').value.trim();
      if (!code) return alert('å•†å“ã‚³ãƒ¼ãƒ‰ã¯å¿…é ˆã§ã™');
      const exists = state.items.find(item => item.code === code && !item.deleted);
      if (exists) return alert('å•†å“ã‚³ãƒ¼ãƒ‰ãŒé‡è¤‡ã—ã¦ã„ã¾ã™');

      const item = {
        id: `item-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`,
        code,
        name: document.getElementById('itemName').value.trim(),
        maker: document.getElementById('itemMaker').value.trim(),
        model: document.getElementById('itemModel').value.trim(),
        category: document.getElementById('itemCategory').value.trim(),
        minStock: Number(document.getElementById('itemMin').value) || 0,
        stock: Number(document.getElementById('itemStock').value) || 0,
        baseStock: Number(document.getElementById('itemStock').value) || 0,
        price: Number(document.getElementById('itemPrice').value) || 0,
        leadTime: Number(document.getElementById('itemLead').value) || 0,
        cycleDays: Number(document.getElementById('itemCycle').value) || 0,
        notes: document.getElementById('itemNotes').value.trim(),
        deleted: false,
        orderRequest: null,
        lastInventoryDate: '',
        lastUseDate: ''
      };

      addToHistory('names', item.name);
      addToHistory('makers', item.maker);
      addToHistory('models', item.model);
      addToHistory('categories', item.category);
      assignCategoryColor(item.category);

      state.items.push(item);
      clearItemModal();
      saveAll();
      closeModal('itemModal');
    };

    const clearItemModal = () => {
      ['itemCode','itemName','itemMaker','itemModel','itemCategory','itemMin','itemStock','itemPrice','itemLead','itemCycle','itemNotes']
        .forEach(id => { document.getElementById(id).value = ''; });
    };

    const editItem = (itemId) => {
      const item = state.items.find(i => i.id === itemId);
      if (!item) return;
      document.getElementById('itemCode').value = item.code;
      document.getElementById('itemName').value = item.name;
      document.getElementById('itemMaker').value = item.maker;
      document.getElementById('itemModel').value = item.model;
      document.getElementById('itemCategory').value = item.category;
      document.getElementById('itemMin').value = item.minStock;
      document.getElementById('itemStock').value = item.stock;
      document.getElementById('itemPrice').value = item.price;
      document.getElementById('itemLead').value = item.leadTime;
      document.getElementById('itemCycle').value = item.cycleDays;
      document.getElementById('itemNotes').value = item.notes;
      openModal('itemModal');

      const saveButton = document.querySelector('#itemModal .btn.primary');
      saveButton.onclick = () => {
        const newCode = document.getElementById('itemCode').value.trim();
        if (!newCode) return alert('å•†å“ã‚³ãƒ¼ãƒ‰ã¯å¿…é ˆã§ã™');
        if (newCode !== item.code && state.items.find(other => other.code === newCode && !other.deleted)) {
          return alert('å•†å“ã‚³ãƒ¼ãƒ‰ãŒé‡è¤‡ã—ã¦ã„ã¾ã™');
        }
        item.code = newCode;
        item.name = document.getElementById('itemName').value.trim();
        item.maker = document.getElementById('itemMaker').value.trim();
        item.model = document.getElementById('itemModel').value.trim();
        item.category = document.getElementById('itemCategory').value.trim();
        item.minStock = Number(document.getElementById('itemMin').value) || 0;
        item.stock = Number(document.getElementById('itemStock').value) || 0;
        item.baseStock = item.stock;
        item.price = Number(document.getElementById('itemPrice').value) || 0;
        item.leadTime = Number(document.getElementById('itemLead').value) || 0;
        item.cycleDays = Number(document.getElementById('itemCycle').value) || 0;
        item.notes = document.getElementById('itemNotes').value.trim();

        addToHistory('names', item.name);
        addToHistory('makers', item.maker);
        addToHistory('models', item.model);
        addToHistory('categories', item.category);
        assignCategoryColor(item.category);

        clearItemModal();
        closeModal('itemModal');
        saveAll();
        document.querySelector('#itemModal .btn.primary').onclick = saveItem;
      };
    };

    const deleteItem = (itemId) => {
      const item = state.items.find(i => i.id === itemId);
      if (!item) return;
      if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆè«–ç†å‰Šé™¤ï¼‰')) return;
      item.deleted = true;
      saveAll();
    };

    const openInventory = () => {
      renderInventoryList();
      openModal('inventoryModal');
    };

    const renderInventoryList = () => {
      const sortBy = document.getElementById('inventorySort').value;
      const items = state.items.filter(item => !item.deleted);
      items.sort((a, b) => {
        if (sortBy === 'category') {
          return (a.category || '').localeCompare(b.category || '') || a.name.localeCompare(b.name);
        }
        return a.name.localeCompare(b.name);
      });
      const container = document.getElementById('inventoryList');
      container.innerHTML = items.map(item => {
        const draftValue = state.inventoryDraft[item.id];
        const value = draftValue !== undefined ? draftValue : item.stock;
        return `
          <div class="card">
            <div class="inventory-row">
              <div>
                <div style="font-weight:700;">${item.name}</div>
                <div class="muted">${item.category} / ç¾åœ¨åº«: ${item.stock}</div>
              </div>
              <input class="input small" type="number" inputmode="numeric" value="${value}" onchange="updateInventoryDraft('${item.id}', this.value)">
            </div>
          </div>
        `;
      }).join('');
    };

    const updateInventoryDraft = (itemId, value) => {
      state.inventoryDraft[itemId] = Number(value) || 0;
      saveState();
    };

    const confirmInventory = () => {
      const now = new Date();
      state.items.filter(item => !item.deleted).forEach(item => {
        const newValue = state.inventoryDraft[item.id];
        if (newValue === undefined) return;
        if (item.stock !== newValue) {
          item.stock = newValue;
          item.lastInventoryDate = now.toISOString().slice(0, 10);
          const log = {
            id: `log-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`,
            timestamp: now.getTime(),
            date: now.toLocaleString('ja-JP'),
            itemCode: item.code,
            itemName: item.name,
            category: item.category,
            type: 'æ£šå¸',
            qty: newValue,
            afterStock: newValue,
            useReason: '',
            suddenReason: '',
            note: 'æ£šå¸ç¢ºå®š',
            editedAt: ''
          };
          state.logs.unshift(log);
        }
      });
      state.inventoryDraft = {};
      saveAll();
      closeModal('inventoryModal');
      alert('æ£šå¸ã‚’ç¢ºå®šã—ã¾ã—ãŸ');
    };

    const openHistoryEdit = (logId) => {
      const log = state.logs.find(l => l.id === logId);
      if (!log) return;
      state.selectedLogId = logId;
      document.getElementById('editType').value = log.type;
      document.getElementById('editQty').value = log.qty;
      document.getElementById('editAfter').value = log.afterStock;
      document.getElementById('editReason').value = log.useReason || '';
      document.getElementById('editSudden').value = log.suddenReason || '';
      document.getElementById('editNote').value = log.note || '';
      openModal('historyEditModal');
    };

    const saveHistoryEdit = () => {
      const log = state.logs.find(l => l.id === state.selectedLogId);
      if (!log) return;
      log.type = document.getElementById('editType').value;
      log.qty = Number(document.getElementById('editQty').value) || 0;
      log.afterStock = Number(document.getElementById('editAfter').value) || 0;
      log.useReason = document.getElementById('editReason').value;
      log.suddenReason = document.getElementById('editSudden').value;
      log.note = document.getElementById('editNote').value;
      log.editedAt = new Date().toISOString();
      recalcStocks();
      saveAll();
      closeModal('historyEditModal');
    };

    const recalcStocks = () => {
      const itemsByCode = Object.fromEntries(state.items.map(item => [item.code, item]));
      state.items.forEach(item => {
        item.stock = item.baseStock || 0;
        item.lastUseDate = '';
      });
      const logsAsc = [...state.logs].sort((a, b) => a.timestamp - b.timestamp);
      logsAsc.forEach(log => {
        const item = itemsByCode[log.itemCode];
        if (!item || item.deleted) return;
        if (log.type === 'ä½¿ç”¨') {
          item.stock = Math.max(0, item.stock - log.qty);
          item.lastUseDate = new Date(log.timestamp).toISOString().slice(0, 10);
          log.afterStock = item.stock;
        } else if (log.type === 'ç´å…¥') {
          item.stock = log.qty;
          log.afterStock = item.stock;
        } else if (log.type === 'æ£šå¸' || log.type === 'ä¿®æ­£') {
          item.stock = log.afterStock || log.qty;
        }
      });
    };

    const parseCSV = (text) => {
      const rows = [];
      let current = '';
      let inQuotes = false;
      let row = [];
      for (let i = 0; i < text.length; i) {
        const char = text[i];
        const next = text[i  1];
        if (char === '"' && next === '"') {
          current = '"';
          i;
        } else if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          row.push(current);
          current = '';
        } else if ((char === '\n' || char === '\r') && !inQuotes) {
          if (current || row.length) {
            row.push(current);
            rows.push(row);
            row = [];
            current = '';
          }
        } else {
          current = char;
        }
      }
      if (current || row.length) {
        row.push(current);
        rows.push(row);
      }
      return rows;
    };

    const exportItemsCSV = () => {
      const headers = ['å•†å“ã‚³ãƒ¼ãƒ‰','å“å','ãƒ¡ãƒ¼ã‚«ãƒ¼','å‹å¼','ã‚«ãƒ†ã‚´ãƒªãƒ¼','æœ€ä½åœ¨åº«æ•°','ç¾åœ¨åº«æ•°','é‡‘é¡','ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ','äº¤æ›å‘¨æœŸ','å‚™è€ƒ'];
      const rows = state.items.filter(item => !item.deleted).map(item => [
        item.code, item.name, item.maker, item.model, item.category, item.minStock, item.stock, item.price, item.leadTime, item.cycleDays, item.notes
      ]);
      downloadCSV('items.csv', [headers, ...rows]);
    };

    const exportHistoryCSV = () => {
      const headers = ['æ—¥æ™‚','å•†å“ã‚³ãƒ¼ãƒ‰','å•†å“å','ã‚«ãƒ†ã‚´ãƒªãƒ¼','æ“ä½œç¨®åˆ¥','æ•°é‡','æ“ä½œå¾Œåœ¨åº«æ•°','ä½¿ç”¨ç†ç”±','çªç™ºäº¤æ›ç†ç”±'];
      const rows = state.logs.map(log => [
        log.date, log.itemCode, log.itemName, log.category, log.type, log.qty, log.afterStock, log.useReason, log.suddenReason
      ]);
      downloadCSV('history.csv', [headers, ...rows]);
    };

    const downloadCSV = (filename, rows) => {
      const csv = rows.map(row => row.map(value => {
        const str = value === undefined ? '' : String(value);
        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
          return `"${str.replace(/"/g, '""')}"`;
        }
        return str;
      }).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    };

    const importItemsCSV = async (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const text = await file.text();
      const rows = parseCSV(text);
      if (rows.length <= 1) return;
      const headers = rows[0];
      const dataRows = rows.slice(1);
      dataRows.forEach(row => {
        const record = {};
        headers.forEach((header, index) => {
          record[header] = row[index] || '';
        });
        if (!record['å•†å“ã‚³ãƒ¼ãƒ‰']) return;
        const existing = state.items.find(item => item.code === record['å•†å“ã‚³ãƒ¼ãƒ‰']);
        const payload = {
          code: record['å•†å“ã‚³ãƒ¼ãƒ‰'],
          name: record['å“å'] || '',
          maker: record['ãƒ¡ãƒ¼ã‚«ãƒ¼'] || '',
          model: record['å‹å¼'] || '',
          category: record['ã‚«ãƒ†ã‚´ãƒªãƒ¼'] || '',
          minStock: Number(record['æœ€ä½åœ¨åº«æ•°']) || 0,
          stock: Number(record['ç¾åœ¨åº«æ•°']) || 0,
          price: Number(record['é‡‘é¡']) || 0,
          leadTime: Number(record['ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ']) || 0,
          cycleDays: Number(record['äº¤æ›å‘¨æœŸ']) || 0,
          notes: record['å‚™è€ƒ'] || ''
        };
        if (existing) {
          Object.assign(existing, payload);
          existing.baseStock = existing.stock;
          existing.deleted = false;
        } else {
          state.items.push({
            id: `item-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`,
            baseStock: payload.stock,
            orderRequest: null,
            lastInventoryDate: '',
            lastUseDate: '',
            deleted: false,
            ...payload
          });
        }
        addToHistory('names', payload.name);
        addToHistory('makers', payload.maker);
        addToHistory('models', payload.model);
        addToHistory('categories', payload.category);
        assignCategoryColor(payload.category);
      });
      saveAll();
      event.target.value = '';
      alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ');
    };

    const renderCalendar = () => {
      const month = state.calendarMonth;
      const year = month.getFullYear();
      const monthIndex = month.getMonth();
      document.getElementById('calendarTitle').textContent = `${year}å¹´${monthIndex  1}æœˆ`;

      const firstDay = new Date(year, monthIndex, 1);
      const lastDay = new Date(year, monthIndex  1, 0);
      const startWeek = firstDay.getDay();
      const totalDays = lastDay.getDate();

      const scheduleMap = buildExchangeSchedule();
      const calendarGrid = document.getElementById('calendarGrid');
      calendarGrid.innerHTML = '';

      const headers = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
      headers.forEach(day => {
        const div = document.createElement('div');
        div.className = 'day-header';
        div.textContent = day;
        calendarGrid.appendChild(div);
      });

      for (let i = 0; i < startWeek; i) {
        const empty = document.createElement('div');
        calendarGrid.appendChild(empty);
      }

      for (let day = 1; day <= totalDays; day) {
        const dateKey = formatDateKey(year, monthIndex, day);
        const hasEvent = scheduleMap[dateKey];
        const cell = document.createElement('button');
        cell.className = `day${hasEvent ? ' has-event' : ''}`;
        cell.textContent = day;
        cell.onclick = () => selectDate(dateKey);
        cell.dataset.date = dateKey;
        calendarGrid.appendChild(cell);
      }

      const today = new Date();
      const todayKey = today.toISOString().slice(0, 10);
      const withinMonth = today.getFullYear() === year && today.getMonth() === monthIndex;
      selectDate(withinMonth ? todayKey : formatDateKey(year, monthIndex, 1));
    };

    const changeMonth = (delta) => {
      state.calendarMonth = new Date(state.calendarMonth.getFullYear(), state.calendarMonth.getMonth()  delta, 1);
      renderCalendar();
    };

    const formatDateKey = (year, monthIndex, day) => {
      const month = String(monthIndex  1).padStart(2, '0');
      const date = String(day).padStart(2, '0');
      return `${year}-${month}-${date}`;
    };

    const selectDate = (dateKey) => {
      document.querySelectorAll('.calendar .day').forEach(cell => {
        cell.classList.toggle('selected', cell.dataset.date === dateKey);
      });
      const scheduleMap = buildExchangeSchedule();
      const list = scheduleMap[dateKey] || [];
      const container = document.getElementById('exchangeList');
      if (list.length === 0) {
        container.textContent = 'è©²å½“ã™ã‚‹äº¤æ›äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
        return;
      }
      container.innerHTML = list.map(item => `<div class="list-item"><strong>${item.name}</strong><div class="muted">ã‚«ãƒ†ã‚´ãƒª: ${item.category} / æ¬¡å›äº¤æ›æ—¥: ${item.nextDate}</div></div>`).join('');
    };

    const buildExchangeSchedule = () => {
      const scheduleMap = {};
      const items = state.items.filter(item => !item.deleted && item.cycleDays > 0);
      items.forEach(item => {
        const lastUse = getLastUseDate(item.code);
        if (!lastUse) return;
        const nextDate = addBusinessDays(new Date(lastUse), item.cycleDays);
        const dateKey = nextDate.toISOString().slice(0, 10);
        if (!scheduleMap[dateKey]) scheduleMap[dateKey] = [];
        scheduleMap[dateKey].push({
          name: item.name,
          category: item.category,
          nextDate: dateKey
        });
      });
      return scheduleMap;
    };

    const getLastUseDate = (code) => {
      const log = state.logs.find(l => l.itemCode === code && l.type === 'ä½¿ç”¨');
      return log ? new Date(log.timestamp).toISOString().slice(0, 10) : null;
    };

    const addBusinessDays = (date, days) => {
      const result = new Date(date);
      let added = 0;
      while (added < days) {
        result.setDate(result.getDate()  1);
        const day = result.getDay();
        if (day !== 0 && day !== 6) added;
      }
      return result;
    };

    const saveAll = () => {
      state.logs = state.logs.slice(0, 1000);
      saveState();
      updateHistoryDatalist();
      renderCategoryFilters();
      calculateTotalAsset();
      renderShortageNotice();
      renderStockList();
      renderHistory();
      renderMasterList();
      renderCalendar();
    };

    const init = () => {
      loadState();
      updateHistoryDatalist();
      renderCategoryFilters();
      calculateTotalAsset();
      renderShortageNotice();
      renderStockList();
      renderHistory();
      renderMasterList();
      renderCalendar();
    };

    init();
  </script>
</body>
</html>

